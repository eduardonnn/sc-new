-- Verifica se o exploit suporta Drawing API
if not Drawing then
    game:GetService("StarterGui"):SetCore("SendNotification",{
        Title = "ESP Indisponível";
        Text = "Seu exploit não suporta a Drawing API.";
        Duration = 8
    })
    return
end

-- Serviços
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local UserInputService = game:GetService("UserInputService")

-- Configurações
_G.ESPEnabled = true
_G.TeamCheck = false
_G.BaseTextSize = 16
_G.MinTextSize = 10
_G.MaxDistance = 300
_G.TextColor = Color3.fromRGB(255, 255, 255)
_G.Outline = true
_G.TextTransparency = 1
_G.TextFont = Drawing.Fonts.UI
_G.DisableKey = Enum.KeyCode.Y

local Typing = false

-- Controle de digitação
UserInputService.TextBoxFocused:Connect(function() Typing = true end)
UserInputService.TextBoxFocusReleased:Connect(function() Typing = false end)

-- Toggle por tecla
UserInputService.InputBegan:Connect(function(input)
    if input.KeyCode == _G.DisableKey and not Typing then
        _G.ESPEnabled = not _G.ESPEnabled
        game:GetService("StarterGui"):SetCore("SendNotification",{
            Title = "ESP (Cafézinho)";
            Text = "ESP " .. (_G.ESPEnabled and "ativado" or "desativado");
            Duration = 4
        })
    end
end)

-- Armazena ESPs ativos
local ESPObjects = {}

-- Remove ESPs de players que saíram
Players.PlayerRemoving:Connect(function(player)
    if ESPObjects[player] then
        ESPObjects[player]:Remove()
        ESPObjects[player] = nil
    end
end)

-- Função para criar texto
local function CreateESPText()
    local text = Drawing.new("Text")
    text.Size = _G.BaseTextSize
    text.Color = _G.TextColor
    text.Center = true
    text.Outline = _G.Outline
    text.Font = _G.TextFont
    text.Transparency = _G.TextTransparency
    text.Visible = false
    return text
end

-- Atualização
RunService.RenderStepped:Connect(function()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") and player.Character:FindFirstChild("Head") and player.Character:FindFirstChildOfClass("Humanoid") and player.Character:FindFirstChildOfClass("Humanoid").Health > 0 then

            if _G.TeamCheck and player.Team == LocalPlayer.Team then
                if ESPObjects[player] then
                    ESPObjects[player].Visible = false
                end
                continue
            end

            if not ESPObjects[player] then
                ESPObjects[player] = CreateESPText()
            end

            local HRP = player.Character.HumanoidRootPart
            local Humanoid = player.Character:FindFirstChildOfClass("Humanoid")
            local pos, onScreen = Camera:WorldToViewportPoint(HRP.Position)

            local distance = (HRP.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
            local textSize = math.clamp(_G.BaseTextSize * (1 - (distance / _G.MaxDistance)), _G.MinTextSize, _G.BaseTextSize)

            if onScreen and _G.ESPEnabled then
                local infoText = string.format("(%dm) %s [%d]", math.floor(distance), player.Name, math.floor(Humanoid.Health))
                local esp = ESPObjects[player]

                esp.Text = infoText
                esp.Size = textSize
                esp.Position = Vector2.new(pos.X, pos.Y - 25)
                esp.Visible = true
            else
                ESPObjects[player].Visible = false
            end
        else
            if ESPObjects[player] then
                ESPObjects[player].Visible = false
                if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
                    ESPObjects[player]:Remove()
                    ESPObjects[player] = nil
                end
            end
        end
    end
end)

-- Mensagem de carregamento
pcall(function()
    game:GetService("StarterGui"):SetCore("SendNotification",{
        Title = "ESP Café";
        Text = "ESP ativado";
        Duration = 15;
    })
end)
